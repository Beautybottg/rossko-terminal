<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Rossko Terminal</title>
    <link rel="icon" type="image/png" href="logo192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { color: #2563eb !important; opacity: 1 !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const CATEGORIES = ['–í–°–ï', '–ú–ê–°–õ–ê', '–§–ò–õ–¨–¢–†–´', '–¢–û–†–ú–û–ó–ê', '–ü–û–î–í–ï–°–ö–ê', '–ü–†–û–ß–ï–ï'];

        const App = () => {
            const [parts, setParts] = useState(() => {
                const saved = localStorage.getItem('rossko_db');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [view, setView] = useState('home');
            const [searchQuery, setSearchQuery] = useState('');
            const [activeCategory, setActiveCategory] = useState('–í–°–ï');
            const [isLoading, setIsLoading] = useState(false);
            const [status, setStatus] = useState(parts.length > 0 ? '–û–Ω–ª–∞–π–Ω (–ö—ç—à)' : '–ó–∞–≥—Ä—É–∑–∫–∞...');

            const processRows = (rows) => {
                return rows.slice(1).map((row, i) => {
                    if (!row[1]) return null;
                    return {
                        id: row[0] || `item-${i}-${Date.now()}`,
                        name: String(row[1]).trim(),
                        brand: String(row[2] || "Rossko"),
                        article: String(row[3] || "‚Äî"),
                        price: parseFloat(String(row[4] || "0").replace(/[^0-9.]/g, '')) || 0,
                        category: String(row[5] || "–ü–†–û–ß–ï–ï").toUpperCase().trim()
                    };
                }).filter(Boolean);
            };

            const loadData = async (isManual = false) => {
                if (isManual) setIsLoading(true);
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞ GitHub
                    const response = await fetch(`data.xlsx?nocache=${Date.now()}`, { 
                        method: 'GET',
                        headers: { 'Cache-Control': 'no-cache' }
                    });
                    
                    if (!response.ok) throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    
                    const arrayBuffer = await response.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    
                    const formatted = processRows(json);
                    if (formatted.length > 0) {
                        setParts(formatted);
                        localStorage.setItem('rossko_db', JSON.stringify(formatted));
                        setStatus('–û–±–Ω–æ–≤–ª–µ–Ω–æ (–û–±–ª–∞–∫–æ)');
                        if (isManual) alert("–ë–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –æ–±–ª–∞–∫–∞!");
                    }
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏, —Ä–∞–±–æ—Ç–∞–µ–º —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–æ–ø–∏–µ–π");
                    if (parts.length > 0) setStatus('–†–∞–±–æ—Ç–∞–µ—Ç (–ö—ç—à)');
                    else setStatus('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–û–ò–°–ö: –ü–†–ò–û–†–ò–¢–ï–¢ –ù–ê–ß–ê–õ–ê –°–õ–û–í–ê
            const filtered = useMemo(() => {
                const query = searchQuery.toLowerCase().trim();
                const words = query.split(/\s+/);
                
                let result = parts.filter(p => {
                    const matchCat = activeCategory === '–í–°–ï' || p.category === activeCategory;
                    if (!query) return matchCat;
                    
                    const name = p.name.toLowerCase();
                    const article = p.article.toLowerCase();
                    const brand = p.brand.toLowerCase();
                    const fullContent = `${name} ${article} ${brand}`;
                    
                    return matchCat && words.every(word => fullContent.includes(word));
                });

                if (query) {
                    result.sort((a, b) => {
                        const nameA = a.name.toLowerCase();
                        const nameB = b.name.toLowerCase();
                        const firstWord = words[0];

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–º–µ–Ω–Ω–æ —Å —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞
                        const startsWithA = nameA.startsWith(firstWord);
                        const startsWithB = nameB.startsWith(firstWord);

                        if (startsWithA && !startsWithB) return -1;
                        if (!startsWithA && startsWithB) return 1;
                        
                        // –ï—Å–ª–∏ –æ–±–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –∏–ª–∏ –æ–±–∞ –Ω–µ—Ç ‚Äî –æ–±—ã—á–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                        return nameA.localeCompare(nameB);
                    });
                }

                return result.slice(0, 50);
            }, [parts, searchQuery, activeCategory]);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white relative pb-20 shadow-2xl">
                    {/* –°—Ç–∞—Ç—É—Å-–±–∞—Ä */}
                    <div className="p-6 pb-2 flex justify-between items-center">
                        <div>
                            <p className="text-[10px] font-black text-blue-600 tracking-widest uppercase">Rossko Terminal</p>
                            <h1 className="text-4xl font-black italic text-gray-800 uppercase leading-none">–°–∫–ª–∞–¥</h1>
                        </div>
                        <div className="flex flex-col items-end">
                            <span className={`text-[8px] font-bold px-2 py-1 rounded uppercase ${status.includes('–û–±–ª–∞–∫–æ') ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}`}>
                                {status}
                            </span>
                        </div>
                    </div>

                    {view === 'home' && (
                        <div className="p-6 space-y-6">
                            <div className="bg-blue-600 p-8 rounded-[32px] text-white relative overflow-hidden shadow-xl active:scale-95 transition-all" onClick={() => setView('search')}>
                                <p className="text-[10px] font-black uppercase opacity-60 tracking-widest">–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π</p>
                                <p className="text-6xl font-black mt-2">{parts.length}</p>
                                <div className="absolute -right-4 -bottom-4 text-8xl font-black italic opacity-10">R</div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={() => setView('search')} className="bg-gray-50 p-6 rounded-[24px] border border-gray-100 text-left active:bg-gray-100">
                                    <span className="text-2xl">üîç</span>
                                    <p className="font-black uppercase text-[10px] mt-4 text-gray-400">–ü–æ–∏—Å–∫</p>
                                </button>
                                <button onClick={() => setView('manage')} className="bg-gray-50 p-6 rounded-[24px] border border-gray-100 text-left active:bg-gray-100">
                                    <span className="text-2xl">üì¶</span>
                                    <p className="font-black uppercase text-[10px] mt-4 text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞</p>
                                </button>
                            </div>
                        </div>
                    )}

                    {view === 'search' && (
                        <div className="p-4 space-y-4">
                            <div className="sticky top-0 bg-white/95 backdrop-blur-sm pt-2 pb-4 z-10 space-y-4">
                                <input 
                                    className="w-full bg-gray-50 border-2 border-gray-100 p-5 rounded-[24px] font-bold outline-none focus:border-blue-500 text-lg shadow-inner"
                                    placeholder="–ù–∞—á–Ω–∏ –ø–∏—Å–∞—Ç—å: –ö—Ä—ã–ª–æ..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    autoFocus
                                />
                                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                    {CATEGORIES.map(c => (
                                        <button key={c} onClick={() => setActiveCategory(c)} 
                                            className={`px-6 py-3 rounded-full text-[10px] font-black whitespace-nowrap transition-all ${activeCategory === c ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-400'}`}>
                                            {c}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="space-y-4">
                                {filtered.map(p => (
                                    <div key={p.id} className="bg-white border border-gray-100 p-6 rounded-[32px] shadow-sm active:bg-gray-50 transition-all">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest">{p.brand}</span>
                                            <span className="text-[10px] font-mono text-gray-300 uppercase">{p.article}</span>
                                        </div>
                                        <p className="font-bold text-gray-800 leading-tight mb-4 text-sm">{p.name}</p>
                                        <div className="flex justify-between items-end">
                                            <p className="text-2xl font-black text-gray-900">{p.price.toLocaleString()} ‚ÇΩ</p>
                                            <span className="text-[9px] font-bold text-gray-300 uppercase">{p.category}</span>
                                        </div>
                                    </div>
                                ))}
                                {filtered.length === 0 && (
                                    <div className="text-center py-20 text-gray-300 font-black uppercase text-[10px]">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                                )}
                            </div>
                        </div>
                    )}

                    {view === 'manage' && (
                        <div className="p-6 space-y-6">
                            <div className="p-10 border-2 border-dashed border-blue-100 rounded-[40px] bg-blue-50/20 text-center">
                                <label className="cursor-pointer block">
                                    <span className="text-4xl block mb-4">üìä</span>
                                    <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª Excel</span>
                                    <input type="file" className="hidden" accept=".xlsx,.xls" onChange={(e) => {
                                        const file = e.target.files[0];
                                        if(!file) return;
                                        const reader = new FileReader();
                                        reader.onload = (evt) => {
                                            try {
                                                const wb = XLSX.read(evt.target.result, {type:'array'});
                                                const ws = wb.Sheets[wb.SheetNames[0]];
                                                const rows = processRows(XLSX.utils.sheet_to_json(ws, {header:1}));
                                                setParts(rows);
                                                localStorage.setItem('rossko_db', JSON.stringify(rows));
                                                alert("–ì–æ—Ç–æ–≤–æ! –ë–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.");
                                            } catch(err) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞"); }
                                        };
                                        reader.readAsArrayBuffer(file);
                                    }} />
                                </label>
                            </div>
                        </div>
                    )}

                    {view === 'profile' && (
                        <div className="p-10 text-center space-y-8">
                            <div className="w-24 h-24 bg-blue-50 rounded-[32px] mx-auto flex items-center justify-center text-4xl shadow-inner">üë§</div>
                            <div className="space-y-3 pt-4">
                                <button 
                                    onClick={() => loadData(true)} 
                                    disabled={isLoading}
                                    className={`w-full py-5 rounded-[24px] font-black uppercase text-[10px] tracking-widest shadow-lg active:scale-95 transition-all ${isLoading ? 'bg-gray-200 text-gray-400' : 'bg-blue-600 text-white'}`}
                                >
                                    {isLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞'}
                                </button>
                                <button 
                                    onClick={() => { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É?')){ localStorage.clear(); window.location.reload(); } }} 
                                    className="w-full py-5 bg-red-50 text-red-500 rounded-[24px] font-black uppercase text-[10px] tracking-widest active:bg-red-100 transition-colors"
                                >
                                    –°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à
                                </button>
                            </div>
                        </div>
                    )}

                    {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 backdrop-blur-xl border-t border-gray-100 flex justify-around py-5 px-4 z-50 rounded-t-[32px] shadow-sm">
                        {[{ id: 'home', icon: 'üè†' }, { id: 'search', icon: 'üîç' }, { id: 'manage', icon: 'üì¶' }, { id: 'profile', icon: 'üë§' }].map(tab => (
                            <button key={tab.id} onClick={() => setView(tab.id)} className={`text-2xl opacity-20 transition-all duration-300 ${view === tab.id ? 'active-tab scale-125' : ''}`}>
                                {tab.icon}
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
