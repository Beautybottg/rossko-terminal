<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Rossko Terminal</title>
    <link rel="icon" type="image/png" href="logo192.png">
    <link rel="apple-touch-icon" href="logo192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; margin: 0; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { color: #2563eb !important; opacity: 1 !important; transform: scale(1.1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-animate { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const CATEGORIES = ['–í–°–ï', '–ú–ê–°–õ–ê', '–§–ò–õ–¨–¢–†–´', '–¢–û–†–ú–û–ó–ê', '–ü–û–î–í–ï–°–ö–ê', '–ü–†–û–ß–ï–ï'];
        const ITEMS_PER_PAGE = 15;

        // --- –†–∞–±–æ—Ç–∞ —Å IndexedDB (–≤–º–µ—Å—Ç–æ localStorage) ---
        const dbName = "RosskoDB";
        const storeName = "parts";

        const initDB = () => new Promise((resolve) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = (e) => e.target.result.createObjectStore(storeName);
            request.onsuccess = (e) => resolve(e.target.result);
        });

        const saveToDB = async (data) => {
            const db = await initDB();
            const tx = db.transaction(storeName, "readwrite");
            tx.objectStore(storeName).put(data, "current_db");
        };

        const getFromDB = async () => {
            const db = await initDB();
            return new Promise((resolve) => {
                const request = db.transaction(storeName).objectStore(storeName).get("current_db");
                request.onsuccess = () => resolve(request.result || []);
            });
        };

        const App = () => {
            const [parts, setParts] = useState([]);
            const [view, setView] = useState('home');
            const [searchQuery, setSearchQuery] = useState('');
            const [activeCategory, setActiveCategory] = useState('–í–°–ï');
            const [currentPage, setCurrentPage] = useState(1);
            const [isLoading, setIsLoading] = useState(false);
            const [status, setStatus] = useState('–ó–∞–≥—Ä—É–∑–∫–∞...');
            const [toast, setToast] = useState(null);
            const [isAppReady, setIsAppReady] = useState(false);
            const [loadProgress, setLoadProgress] = useState(0);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            const processRows = useCallback((rows) => {
                if (!rows || rows.length < 2) return [];
                return rows.slice(1).map((row, i) => {
                    if (!row[1]) return null;
                    return {
                        id: `item-${i}-${Date.now()}`,
                        name: String(row[1]).trim(),
                        brand: String(row[2] || "Rossko"),
                        article: String(row[3] || "‚Äî"),
                        price: parseFloat(String(row[4] || "0").replace(/[^0-9.]/g, '')) || 0,
                        category: String(row[5] || "–ü–†–û–ß–ï–ï").toUpperCase().trim()
                    };
                }).filter(Boolean);
            }, []);

            const loadData = async (isManual = false) => {
                if (isManual) setIsLoading(true);
                if (!isManual) setLoadProgress(20);
                
                try {
                    // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –±—ã—Å—Ç—Ä–æ–π –±–∞–∑—ã
                    const cached = await getFromDB();
                    if (cached.length > 0) setParts(cached);

                    const response = await fetch(`data.xlsx?v=${Date.now()}`, { cache: "no-store" });
                    if (!isManual) setLoadProgress(50);

                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        if (!isManual) setLoadProgress(80);
                        const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                        const ws = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        const formatted = processRows(json);
                        
                        if (formatted.length > 0) {
                            setParts(formatted);
                            await saveToDB(formatted);
                            setStatus('–û–±–Ω–æ–≤–ª–µ–Ω–æ (–û–±–ª–∞–∫–æ)');
                            if (isManual) showToast("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω");
                        }
                    } else {
                        throw new Error();
                    }
                } catch (e) {
                    setStatus(parts.length > 0 || (await getFromDB()).length > 0 ? '–í —Å–µ—Ç–∏ (–ö—ç—à)' : '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                } finally {
                    setIsLoading(false);
                    if (!isManual) {
                        setLoadProgress(100);
                        setTimeout(() => setIsAppReady(true), 600);
                    }
                }
            };

            useEffect(() => { loadData(); }, []);
            useEffect(() => { setCurrentPage(1); }, [searchQuery, activeCategory]);

            const { filteredItems, totalPages } = useMemo(() => {
                const query = searchQuery.toLowerCase().trim();
                const searchWords = query.split(/\s+/).filter(w => w.length > 0);
                let result = parts.filter(p => {
                    const matchCat = activeCategory === '–í–°–ï' || p.category === activeCategory;
                    if (!matchCat) return false;
                    if (searchWords.length === 0) return true;
                    const name = p.name.toLowerCase();
                    const article = p.article.toLowerCase();
                    return searchWords.every(word => {
                        const nameWords = name.split(/[\s,./\-\(\)]+/);
                        return nameWords.some(nw => nw.startsWith(word)) || article.includes(word);
                    });
                });
                if (searchWords.length > 0) {
                    const first = searchWords[0];
                    result.sort((a, b) => {
                        const aStarts = a.name.toLowerCase().startsWith(first);
                        const bStarts = b.name.toLowerCase().startsWith(first);
                        if (aStarts && !bStarts) return -1;
                        if (!aStarts && bStarts) return 1;
                        return a.name.localeCompare(b.name);
                    });
                }
                const pages = Math.ceil(result.length / ITEMS_PER_PAGE);
                const sliced = result.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);
                return { filteredItems: sliced, totalPages: pages };
            }, [parts, searchQuery, activeCategory, currentPage]);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white relative shadow-2xl">
                    {!isAppReady && (
                        <div className="fixed inset-0 z-[100] bg-blue-600 flex flex-col items-center justify-center p-10">
                            <div className="text-white text-8xl font-black italic mb-8 animate-bounce">R</div>
                            <div className="w-full bg-blue-800 h-2 rounded-full overflow-hidden max-w-[200px]">
                                <div className="bg-white h-full transition-all duration-300" style={{ width: `${loadProgress}%` }}></div>
                            </div>
                            <p className="text-white/60 text-[10px] font-black uppercase tracking-widest mt-4">–ó–∞–≥—Ä—É–∑–∫–∞ {loadProgress}%</p>
                        </div>
                    )}
                    {toast && (
                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-[110] w-full px-10 toast-animate">
                            <div className="bg-gray-900 text-white text-[11px] font-bold uppercase tracking-wider py-4 px-6 rounded-2xl text-center shadow-2xl">
                                {toast}
                            </div>
                        </div>
                    )}
                    <div className={isAppReady ? 'block' : 'hidden'}>
                        <div className="p-6 pb-4 flex justify-between items-center bg-white sticky top-0 z-50 border-b border-gray-50">
                            <div>
                                <p className="text-[10px] font-black text-blue-600 tracking-widest uppercase">Rossko Terminal</p>
                                <h1 className="text-3xl font-black italic text-gray-800 uppercase leading-none">–°–∫–ª–∞–¥</h1>
                            </div>
                            <span className={`text-[9px] font-bold px-3 py-1.5 rounded-full uppercase ${status.includes('–û–±–Ω–æ–≤–ª–µ–Ω–æ') ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}`}>
                                {status}
                            </span>
                        </div>
                        <div className="pb-32">
                            {view === 'home' && (
                                <div className="p-6 space-y-6">
                                    <div className="bg-blue-600 p-8 rounded-[35px] text-white relative shadow-xl active:scale-95 transition-all" onClick={() => setView('search')}>
                                        <p className="text-[10px] font-black uppercase opacity-60 tracking-widest">–í—Å–µ–≥–æ –≤ –±–∞–∑–µ</p>
                                        <p className="text-6xl font-black mt-2 tracking-tight">{parts.length}</p>
                                        <div className="absolute -right-4 -bottom-4 text-9xl font-black italic opacity-10">R</div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => setView('search')} className="bg-gray-50 p-6 rounded-[28px] border border-gray-100 text-left active:bg-blue-50 transition-all">
                                            <span className="text-3xl">üîç</span>
                                            <p className="font-black uppercase text-[10px] mt-4 text-gray-400">–ü–æ–∏—Å–∫</p>
                                        </button>
                                        <button onClick={() => setView('manage')} className="bg-gray-50 p-6 rounded-[28px] border border-gray-100 text-left active:bg-blue-50 transition-all">
                                            <span className="text-3xl">üì¶</span>
                                            <p className="font-black uppercase text-[10px] mt-4 text-gray-400">–§–∞–π–ª</p>
                                        </button>
                                    </div>
                                </div>
                            )}
                            {view === 'search' && (
                                <div className="p-4 space-y-4">
                                    <input className="w-full bg-gray-100 border-none p-5 rounded-[22px] font-bold outline-none focus:ring-2 ring-blue-500 text-lg shadow-inner" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                                        {CATEGORIES.map(c => (
                                            <button key={c} onClick={() => setActiveCategory(c)} className={`px-6 py-3 rounded-full text-[10px] font-black transition-all ${activeCategory === c ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-100 text-gray-400'}`}>{c}</button>
                                        ))}
                                    </div>
                                    <div className="space-y-3">
                                        {filteredItems.map(p => (
                                            <div key={p.id} className="bg-white border border-gray-100 p-6 rounded-[30px] shadow-sm">
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest">{p.brand}</span>
                                                    <span className="text-[10px] font-mono text-gray-300 uppercase">{p.article}</span>
                                                </div>
                                                <p className="font-bold text-gray-800 leading-tight mb-4 text-sm">{p.name}</p>
                                                <p className="text-2xl font-black text-gray-900">{p.price.toLocaleString()} ‚ÇΩ</p>
                                            </div>
                                        ))}
                                        {totalPages > 1 && (
                                            <div className="flex justify-between items-center py-6 px-2">
                                                <button disabled={currentPage === 1} onClick={() => { setCurrentPage(p => p - 1); window.scrollTo(0,0); }} className="px-6 py-3 bg-gray-100 rounded-2xl font-black text-[10px] uppercase disabled:opacity-30">–ù–∞–∑–∞–¥</button>
                                                <span className="text-[10px] font-black text-gray-400">–°—Ç—Ä {currentPage}/{totalPages}</span>
                                                <button disabled={currentPage === totalPages} onClick={() => { setCurrentPage(p => p + 1); window.scrollTo(0,0); }} className="px-6 py-3 bg-blue-600 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg">–î–∞–ª–µ–µ</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            {view === 'manage' && (
                                <div className="p-6">
                                    <div className="p-12 border-4 border-dotted border-blue-50 rounded-[45px] bg-blue-50/20 text-center">
                                        <label className="cursor-pointer block">
                                            <span className="text-5xl block mb-6">üìÇ</span>
                                            <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest text-center block">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Ä—É—á–Ω—É—é</span>
                                            <input type="file" className="hidden" accept=".xlsx,.xls" onChange={(e) => {
                                                const file = e.target.files[0];
                                                if(!file) return;
                                                const reader = new FileReader();
                                                reader.onload = async (evt) => {
                                                    try {
                                                        const wb = XLSX.read(evt.target.result, {type:'array'});
                                                        const ws = wb.Sheets[wb.SheetNames[0]];
                                                        const rows = processRows(XLSX.utils.sheet_to_json(ws, {header:1}));
                                                        setParts(rows);
                                                        await saveToDB(rows);
                                                        showToast("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω");
                                                    } catch (err) {
                                                        showToast("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞");
                                                    }
                                                };
                                                reader.readAsArrayBuffer(file);
                                            }} />
                                        </label>
                                    </div>
                                </div>
                            )}
                            {view === 'profile' && (
                                <div className="p-10 text-center space-y-8">
                                    <div className="w-24 h-24 bg-blue-50 rounded-[35px] mx-auto flex items-center justify-center text-4xl">üë§</div>
                                    <div className="space-y-3">
                                        <button onClick={() => loadData(true)} disabled={isLoading} className="w-full py-5 rounded-[22px] bg-blue-600 text-white font-black uppercase text-[10px] tracking-widest shadow-xl active:scale-95 transition-all">
                                            {isLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –û–±–ª–∞–∫–æ'}
                                        </button>
                                        <button onClick={() => { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –ø–∞–º—è—Ç—å?')){ indexedDB.deleteDatabase(dbName); localStorage.clear(); window.location.reload(); } }} className="w-full py-5 bg-red-50 text-red-500 rounded-[22px] font-black uppercase text-[10px] tracking-widest">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
                                    </div>
                                </div>
                            )}
                        </div>
                        <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/80 backdrop-blur-2xl border-t border-gray-100 flex justify-around py-6 px-6 z-50 rounded-t-[40px] shadow-2xl">
                            {[{ id: 'home', icon: 'üè†' }, { id: 'search', icon: 'üîç' }, { id: 'manage', icon: 'üì¶' }, { id: 'profile', icon: 'üë§' }].map(tab => (
                                <button key={tab.id} onClick={() => setView(tab.id)} className={`text-2xl opacity-20 transition-all duration-300 ${view === tab.id ? 'active-tab opacity-100' : ''}`}>
                                    {tab.icon}
                                </button>
                            ))}
                        </nav>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
